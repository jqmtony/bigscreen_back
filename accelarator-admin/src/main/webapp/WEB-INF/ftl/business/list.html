<#assign base=request.contextPath/>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<link rel="stylesheet" type="text/css" href="${base}/easyui/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="${base}/easyui/themes/icon.css" />
<script type="text/javascript" src="${base}/js/jquery.min.js"></script>
<script type="text/javascript" src="${base}/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="${base}/easyui/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="${base}/js/region.js"></script>
<script type="text/javascript" src="${base}/js/extend.js"></script>
</head>
<body>
   <table id="dg_search_0" class="easyui-datagrid" data-options="rownumbers:true,singleSelect:true,url:'${base}/business/queryList',method:'post',toolbar:'#tb',pagination:true,pageSize:20,pageNumber:1,fitColumns:true,fit:true">
		<thead>
			<tr>
				<th data-options="field:'userName',width:80">用户名</th>
				<th data-options="field:'realName',width:100">真实姓名</th>
				<th data-options="field:'mobile',width:80">手机</th>
				<th data-options="field:'email',width:100">邮箱</th>
				<th data-options="field:'country',width:80,formatter:formatCountry">国家</th>
				<th data-options="field:'area',width:80,formatter:formatArea">地区</th>
				<th data-options="field:'createTime',width:100,formatter:formatYYYYMMDD">创建日期</th>
				<th data-options="field:'status',width:60,formatter:formatStatus">是否启用</th>
			</tr>
		</thead>
	</table>
	
	<div id="tb" style="padding:2px 5px;">
	            国家： <select id="country" class="easyui-combobox" style="width:90px;"></select>
	            地区：  <select id="area" class="easyui-combobox" style="width:90px;"></select>
	            城市：  <select id="city" class="easyui-combobox" style="width:90px;"></select>
		用户名： <input class="easyui-textbox" type="text" id="userName" style="width:110px">
		真实姓名： <input class="easyui-textbox" type="text" id="realName" style="width:110px">
		<a href="javascript:void(0);" onclick="search_()" class="easyui-linkbutton" iconCls="icon-search">查询</a>
		<a href="javascript:void(0);" id="btn_add_user" class="easyui-linkbutton" data-options="iconCls:'icon-add',toggle:true">添加</a>
		<a href="javascript:void(0);" class="easyui-linkbutton" onclick="dg_remove_row();" data-options="iconCls:'icon-remove',toggle:true">删除</a>
		<a href="javascript:void(0);" class="easyui-linkbutton" onclick="dg_update();" data-options="iconCls:'icon-cut',toggle:true">修改</a>
	</div>
	
	<div id="win_add_user" class="easyui-window" title="新增商家账号" data-options="collapsible:false,minimizable:false,closed:true" style="width:600px;height:450px;padding:10px;">
	     <form id="save_form" method="post">
	    	<table cellpadding="5">
	    		<tr>
	    			<td>用户名：</td>
	    			<td><!-- <input type="hidden" name="id"></input> -->
	    			    <input id="_userName_" class="easyui-textbox" type="text" name="userName" data-options="required:true"></input></td>
	    			<td>真实姓名：</td>
	    			<td><input id="_realName_" class="easyui-textbox" type="text" name="realName" data-options="required:true"></input></td>
	    		</tr>
	    		<tr>
	    			<td>密码：</td>
	    			<td><input id="_password_" class="easyui-textbox" type="password" name="password" data-options="required:true"></input></td>
	    			<td>确认密码：</td>
	    			<td><input id="_ret_password_" class="easyui-textbox" type="password" name="ret_password" data-options="required:true"></input></td>
	    		</tr>
	    		<tr>
	    			<td>国家：</td>
	    			<td><select id="_country_" name="country" class="easyui-combobox" style="width:110px;">
	    			 <option value="1">美国</option>
	    			   <option value="1">美国</option>
	    			   <option value="1">美国</option>
	    			</select></td>
	    			<td>地区：</td>
	    			<td><select id="_area_" name="area" class="easyui-combobox" style="width:110px;">
	    			<option value="10">华盛顿</option>
	    			<option value="10">华盛顿</option>
	    			</select></td>
	    		</tr>
	    		<tr>
	    			<td>手机：</td>
	    			<td><input id="_mobile_" class="easyui-textbox" type="text" name="mobile" data-options="required:true"></input></td>
	    			<td>电子邮箱：</td>
	    			<td><input id="_email_" class="easyui-textbox" type="text" name="email" data-options="required:true,validType:'email'"></input></td>
	    		</tr>
	    		<tr>
	    			<td>微信号：</td>
	    			<td><input id="_weixin_" class="easyui-textbox" type="text" name="weixin"></input></td>
	    			<td>FaceBook：</td>
	    			<td><input id="_facebook_" class="easyui-textbox" type="text" name="facebook"></input></td>
	    		</tr>
	    		<tr>
	    			<td>出生年月：</td>
	    			<td colspan="3"><input id="_birthday_" class="easyui-textbox" type="text" name="birthday"></input></td>
	    		</tr>
	    		<tr>
	    			<td>备注：</td>
	    			<td><input id="_remark_" class="easyui-textbox" name="remark" data-options="multiline:true" style="height:60px"></input></td>
	    		</tr>
               </table>
            </form>
            <div style="text-align:center;padding:5px">
		    	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()">保存</a>
		    	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="closeForm()">关闭</a>
		    </div>
            
    </div>
    <#include "./add.html">
    <#include "./update.html">
</body>
</html>

<script>
$(function(){
	$("#btn_add_user").click(function(){
		$("#win_add_user").window('open');
	});
	
	var country_json=[{'id':0,'text':'全部'}];
	for(i=0;i<xzqh.length;i++){
		var country={};
		country.id = xzqh[i].id;
		country.text = xzqh[i].text;
		country_json.push(country);
	}
	
	$('#country,#s_country').combobox({
	    valueField:'id',
	    textField:'text',
	    data:country_json
	});
	
	var area_json=[{'id':0,'text':'全部'}];
	$('#area,#s_area').combobox({
	    valueField:'id',
	    textField:'text',
	    data:area_json
	});
	
	$('#country,#s_country').combobox({
	   onChange: function(newValue,oldValue){
		  area_json = [{'id':0,'text':'全部'}];
		  for(i=0;i<xzqh.length;i++){
				var children = xzqh[i].children;
				if(newValue==xzqh[i].id){
					for(j=0;j<children.length;j++){
						var area={};
						area.id = children[j].id;
						area.text = children[j].text;
						area_json.push(area);
					}
				}
		  }
		  $('#area,#s_area').combobox({
			    valueField:'id',
			    textField:'text',
			    data:area_json
		  });
	   }
	});
});

function submitForm(){
	$('#save_form').form('submit',{
		url:'${base}/business/add',
		onSubmit:function(){
	        return $(this).form('validate');
	    },
	    success:function(msg){
	    	msg = eval("("+msg+")");
	    	if (msg.code == '200') {
	    		closeForm();
				$('#dg_search_0').datagrid('reload');
				$.messager.show({
					title : '操作结果',
					msg : '操作成功！',
					timeout : 2000,
					showType : 'slide'
				});
			}
	    }
	});
}


function closeForm(){
	$('#save_form').form('clear');
	$("#win_add_user").window('close');
}

function search_() {
   var settings={
		url:'${base}/business/list',
		params:{
			country:$('#country').combobox('getValue'),
			area:$('#area').combobox('getValue'),
			userName:$("#userName").val(),
			realName:$("#realName").val()
		}
   };
   crud.search(settings);
}

function dg_remove_row() {
	var record = $('#dg_search_0').datagrid('getSelected');
	if (null == record) {
		$.messager.alert('消息提示', '请选择删除记录行！', 'info');
	} else {
		$.ajax({
			type : "POST",
			url : "${base}/business/delete",
			data : {
				id : record.id,
				status : 2
			},
			success : function(msg) {
				if (msg.code == '200') {
					$('#dg_search_0').datagrid('reload');
					$.messager.show({
						title : '操作结果',
						msg : '操作成功！',
						timeout : 2000,
						showType : 'slide'
					});
				}
			}
		})
	}
}

function dg_update(){
	var record = $('#dg_search_0').datagrid('getSelected');
	if (null == record) {
		$.messager.alert('消息提示', '请选择删除记录行！', 'info');
	} else {
		$('#save_form').form('load','${base}/business/toUpdate?id='+record.id);
		$("#win_add_user").window('open');
		/* $.ajax({
			type : "POST",
			url : "${base}/business/toUpdate",
			data : {
				id : record.id,
			},
			success : function(data) {
				$(":input[name='id']").val(data.id);
				$("#_userName_").textbox('setValue',data.userName);
				$("#_realName_").textbox('setValue',data.userName);
				$("#_password_,#_ret_password_").textbox('setValue',data.password);
				$("#_mobile_").textbox('setValue',data.mobile);
				$("#_email_").textbox('setValue',data.email);
				$("#_weixin_").textbox('setValue',data.weixin);
				$("#_facebook_").textbox('setValue',data.facebook);
				$("#_brithday_").textbox('setValue',data.brithday);
				$("#_remark_").textbox('setValue',data.remark);
				$("#win_add_user").window('open');
			}
		}) */
	}
}

function formatCountry(val, row) {
	var text='暂无';
	for(i=0;i<xzqh.length;i++){
		if(xzqh[i].id==val){
			text = xzqh[i].text;
			break;
		}
	}
	return text;
}

function formatArea(val, row) {
	var text='暂无';
	for(i=0;i<xzqh.length;i++){
		var children = xzqh[i].children;
		for(j=0;j<children.length;j++){
			if(children[j].id==val){
				text = children[j].text;
				break;
			}
		}
	}
	return text;
}

function formatStatus(val, row) {
	if (val == 1) {
		return '已启用';
	} else {
		return '已禁用';
	}
}
</script>