<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gochinatv.accelarator.dao.PlaceDao">

	<resultMap type="Place" id="Place">
		<id property="id" column="id" />
		<result property="cname" column="cname" />
		<result property="ename" column="ename" />
		<result property="type" column="type" />
		<result property="scale" column="scale" />
		<result property="averageDailyFlow" column="average_daily_flow" />
		<result property="countryCode" column="country_code" />
		<result property="areaCode" column="area_code" />
		<result property="cityCode" column="city_code" />
		<result property="address" column="address" />
		<result property="zipCode" column="zip_code" />
		<result property="businessId" column="business_id" />
		<result property="createTime" column="create_time" />
		
		<result property="userName" column="user_name" />
	</resultMap>
	
	<select id="getBusinessIdById" resultType="Integer" parameterType="Integer">
		select business_id from place where id=#{id}
	</select>
	
	<select id="getListByEntity" resultMap="Place" parameterType="Place">
		select p.*, b.user_name from place p left join business b on p.business_id=b.id
		<where>
			1=1
			<if test="cname!=null">
				and cname like CONCAT(CONCAT('%',#{cname}),'%')
			</if>
			<if test="ename!=null">
				and ename like CONCAT(CONCAT('%',#{ename}),'%')
			</if>
			<if test="type!=null and type!=0">
				and type = #{type}
			</if>
			<if test="countryCode!=null and countryCode!=''">
				and country_code = #{countryCode}
			</if>
			<if test="areaCode!=null and areaCode!=''" >
				and area_code = #{areaCode}
			</if>
			<if test="cityCode!=null and cityCode!=''">
				and city_code = #{cityCode}
			</if>
			order by create_time desc
		</where>
	</select>
	
	<select id="getEntityById" resultMap="Place" parameterType="int">
		select * from place where id=#{id}
	</select>
	
	<insert id="save" parameterType="Place">
	   insert into place(
	            cname,
	            ename,
	            type,
	            scale,
	            average_daily_flow,
	            country_code,
	            area_code,
	            city_code,
	            address,
	            zip_code,
	            business_id,
	            create_time
	            ) values (
	            #{cname},
	            #{ename},
	            #{type},
	            #{scale},
	            #{averageDailyFlow},
	            #{countryCode},
	            #{areaCode},
	            #{cityCode},
	            #{address},
	            #{zipCode},
	            #{businessId},
	            #{createTime}
	            )
	</insert>
	
	<update id="update" parameterType="Place">
		update place
		<set>
			cname=#{cname},
            ename=#{ename},
            type=#{type},
            scale=#{scale},
            average_daily_flow=#{averageDailyFlow},
            country_code=#{countryCode},
            area_code=#{areaCode},
            city_code=#{cityCode},
            address=#{address},
            zip_code=#{zipCode},
            business_id=#{businessId}            
		</set>
		where id = #{id}
	</update>
	
	<delete id="deleteByEntity" parameterType="Place">
	  delete from place where id = #{id}
	</delete>
	
	<select id="getAvailableList" resultMap="Place" resultType="Place">
	    SELECT DISTINCT p.id,p.cname,p.type,p.country_code,p.area_code,p.city_code FROM place p 
	    LEFT JOIN orders_detail od ON p.country_code=od.country_code AND p.area_code=od.area_code AND p.city_code=od.city_code 
        LEFT JOIN orders o ON od.orders_id=o.id 
        <where>
			1=1
			<if test="type!=null">
				and p.type = #{type}
			</if>
			<if test="cityCode!=null">
				and p.city_code in(${cityCode})
			</if>
			<if test="startTime!=null">
				and o.start_time &gt;= #{startTime}
			</if>
			<if test="endTime!=null">
				and o.end_time &lt;= #{endTime}
			</if>
			
		</where>
	</select>

</mapper>